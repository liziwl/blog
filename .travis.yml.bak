language: node_js   # 设置语言
node_js: stable     # 设置相应的版本

git:
  submodules:
    false

# cache:
#     directories:
#         - node_modules    # 据说可以减少Travis构建时间

before_install:
  - export TZ='Asia/Shanghai'   # 更改时区
  - node --version
  - npm --version
  - npm install hexo-cli -g # 安装hexo插件
  # - npm install gulp -g     # 安装静态页面压缩插件

install:
  - npm install   # 安装hexo插件

before_script:
  - git clone --quiet "https://${GH_TOKEN}@${GH_THEME}" themes/next/
  - git clone --quiet "https://${GH_IMG}" source/photos/images/

script:
  - hexo clean   # 清除
  - hexo g   # 生成
  - cp ./source/photos/photoslist.json ./public/photos/ # fix a json generation bug
  # - gulp

after_script:
  - git clone https://${GH_REF} .deploy_git  # GH_REF是最下面配置的仓库地址
  - cd .deploy_git
  - git checkout master
  - cd ../
  - mv .deploy_git/.git/ ./public/   # 这一步之前的操作是为了保留master分支的提交记录，不然每次git init的话只有1条commit
  - cd ./public
  - git config user.name "liziwl"  # 修改name
  - git config user.email "leezisy@gmail.com"  # 修改email
  - git add .
  - git commit -m "Travis-CI Auto Builder at `date +"%Y-%m-%d %H:%M"`"  # 提交记录包含时间 跟上面更改时区配合
  - git push --quiet "https://${GH_TOKEN}@${GH_REF}" master:master  # GH_TOKEN是在Travis中配置环境变量的名称

branches:
  only:
    - src  # 只监测这个分支，一有动静就开始构建

env:
    global:
        - GH_REF: github.com/liziwl/liziwl.github.io.git    # hexo 仓库地址
        - GH_THEME: github.com/liziwl/hexo-theme-next-mod.git   # hexo 主题地址
        - GH_IMG: git.dev.tencent.com/lizi_wl/BlogPhotos.git   # images 地址
